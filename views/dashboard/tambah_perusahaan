<?php
// Pastikan file fungsi Supabase di-include dengan benar
include '../../function/supabase.php';

// LOGIC: Jika Tombol Simpan Ditekan
if (isset($_POST['simpan'])) {
    
    // --- PENTING ---
    // Ganti angka 1 ini dengan ID pengguna (Admin) yang sedang login. 
    // ID ini harus ada di tabel 'pengguna' agar relasi ke perusahaan bisa dibuat.
    $admin_user_id = 1; 
    
    $data_insert = [
        'nama_perusahaan' => $_POST['nama'], 
        'deskripsi'       => $_POST['deskripsi'], 
        'website'         => $_POST['website'], 
        // Mengirim ID pengguna untuk memenuhi kebutuhan relasi/RLS (Row Level Security)
        'id_pengguna'     => $admin_user_id
    ];

    // Panggil fungsi insert Supabase
    $result = supabaseInsert('perusahaan', $data_insert);

    if ($result['success']) {
        echo "<script>alert('Berhasil menambah perusahaan!'); window.location='index.php';</script>";
    } else {
        // Pesan error jika gagal, sangat berguna untuk debugging RLS/koneksi
        $error = "Gagal menyimpan. Cek kembali hak akses (RLS) di Supabase. Detail: " . print_r($result, true);
    }
}

// Include bagian layout
include 'header.php';
include 'topbar.php';
include 'sidebar.php';
?>

<div class="main-content">
    <div class="card p-4 shadow-sm border-0">
        <h5 class="fw-bold mb-4">Tambah Perusahaan Baru</h5>

        <?php if(isset($error)): ?>
            <div class="alert alert-danger">
                <strong>Error:</strong> <?= $error ?>
            </div>
        <?php endif; ?>

        <form method="POST" action="">
            <div class="mb-3">
                <label class="form-label">Nama Perusahaan</label>
                <input type="text" name="nama" class="form-control" required placeholder="Contoh: PT Teknologi Maju">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Website</label>
                <input type="url" name="website" class="form-control" placeholder="https://...">
            </div>

            <div class="mb-3">
                <label class="form-label">Deskripsi</label>
                <textarea name="deskripsi" class="form-control" rows="4" placeholder="Deskripsi singkat perusahaan..."></textarea>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" name="simpan" class="btn btn-primary">
                    <i class="bi bi-save"></i> Simpan Data
                </button>
                <a href="index.php" class="btn btn-secondary">Batal</a>
            </div>
        </form>
    </div>
</div>

<?php include 'footer.php'; ?>